<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DnD Battle Grid</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: row;
      margin: 0;
      padding: 0;
      background-color: #2e2e2e;
      color: white;
      height: 100vh;
    }

    #sidebar {
      width: 260px;
      background-color: #1f1f1f;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      overflow-y: auto;
    }

    .library-token {
      width: 50px;
      height: 50px;
      cursor: grab;
      border: 1px solid #666;
      object-fit: cover;
      margin: 4px;
    }

    .category {
      border: 1px solid #333;
      padding: 0.5rem;
      border-radius: 6px;
      background: #151515;
    }

    .category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .category-images {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }

    #controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    #grid-container {
      position: relative;
      aspect-ratio: 1 / 1;
      width: 1000px;
    }

    #background {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #grid {
      display: grid;
      gap: 1px;
      background-color: transparent;
      border: 2px solid #555;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      width: 100%;
      height: 100%;
    }

    .cell {
      background-color: transparent; 
      border: 2px solid rgba(0, 0, 0, 0.8); 
      position: relative;
    }

    .token {
      position: absolute;
      cursor: grab;
      z-index: 3;
      object-fit: cover;
    }
    #drawLayer {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 2;
    }  


    input[type="file"], select {
      margin: 0.5rem 0;
    }

    .small {
      font-size: 0.85rem;
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCIZjiTltMTVktH4qTuW4iclUqFwuIbU9E",
      authDomain: "heil-47dc3.firebaseapp.com",
      databaseURL: "https://heil-47dc3-default-rtdb.firebaseio.com",
      projectId: "heil-47dc3",
      storageBucket: "heil-47dc3.appspot.com",
      messagingSenderId: "204548727050",
      appId: "1:204548727050:web:14066e11908a1fd97f9af3",
      measurementId: "G-TJZZDNCV05"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>
  <div id="sidebar">
    <h3 style="margin:0 0 6px 0">Knihovna</h3>

    <div style="display:flex; gap:6px; align-items:center;">
      <input id="newCategoryName" placeholder="Nová kategorie" class="small" style="flex:1; padding:4px;" />
      <button id="createCategoryBtn" style="padding:4px 6px;">Vytvořit</button>
    </div>

    <label class="small">Nahrát obrázek do vybrané kategorie:</label>
    <input type="file" id="libraryUpload" accept="image/*" />

    <div id="categoriesList"></div>

    <button id="deleteAllTokensBtn" style="margin-top: auto; background:#b33; color:#fff; border:none; padding:0.5rem; border-radius:4px; cursor:pointer;">
  Smazat všechny tokeny
</button>
  </div>
  <div id="main">
    <h1>DnD Fight Grid</h1>
    <div id="controls">
      <label>Nahrát tokeny: <input type="file" id="upload" accept="image/*" /></label>
      <label>Nahrát pozadí: <input type="file" id="backgroundUpload" accept="image/*" /></label>
      <label>Velikost polí:
        <select id="cellSizeSelect">
          <option value="25">25px (40x40)</option>
          <option value="33">33px (30x30)</option>
          <option value="50" selected>50px (20x20)</option>
          <option value="100">100px (10x10)</option>
          <option value="200">200px (5x5)</option>
        </select>
      </label>
    </div>
    <div id="controls">
      <label>Barva kreslení: <input type="color" id="drawColor" value="#ff0000"></label>
      <button id="toggleDraw">Režim kreslení</button>
      <button id="clearCanvas">Smazat kresby</button>
    </div>

    <div id="grid-container">
      <img id="background" />
      <canvas id="drawLayer"></canvas>
      <div id="grid"></div>
    </div>
  </div>
    <script>
const grid = document.getElementById('grid');
const gridContainer = document.getElementById('grid-container');
const cellSizeSelect = document.getElementById('cellSizeSelect');
let cellSize = parseInt(cellSizeSelect.value);

function createGrid() {
  grid.innerHTML = '';
  const containerWidth = gridContainer.clientWidth;
  const containerHeight = gridContainer.clientHeight;

  const columns = Math.floor(containerWidth / cellSize);
  const rows = Math.floor(containerHeight / cellSize);

  grid.style.gridTemplateColumns = `repeat(${columns}, ${cellSize}px)`;
  grid.style.gridTemplateRows = `repeat(${rows}, ${cellSize}px)`;

  for (let i = 0; i < columns * rows; i++) {
    const cell = document.createElement('div');
    cell.classList.add('cell');
    grid.appendChild(cell);
  }
}

cellSizeSelect.addEventListener('change', () => {
  const newCellSize = parseInt(cellSizeSelect.value);
  const scale = newCellSize / cellSize;
  cellSize = newCellSize;
  createGrid();

  document.querySelectorAll('.token').forEach(token => {
    const currentLeft = parseFloat(token.style.left) || 0;
    const currentTop = parseFloat(token.style.top) || 0;
    const newLeft = currentLeft * scale;
    const newTop = currentTop * scale;
    token.style.width = `${cellSize}px`;
    token.style.height = `${cellSize}px`;
    token.style.left = `${newLeft}px`;
    token.style.top = `${newTop}px`;

    const tokenId = token.dataset.id;
    if (tokenId) {
      db.ref('tokens/' + tokenId).update({
        top: newTop,
        left: newLeft,
        width: cellSize,
        height: cellSize
      });
    }
  });
});

createGrid();

const upload = document.getElementById('upload');
const db = firebase.database();

upload.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (event) {
    const id = Date.now();
    const tokenData = {
      id,
      src: event.target.result,
      top: 0,
      left: 0,
      width: cellSize,
      height: cellSize
    };
    db.ref('tokens/' + id).set(tokenData);
  };

  reader.readAsDataURL(file);
  e.target.value = "";
});


db.ref('tokens').on('value', (snapshot) => {
  const tokens = snapshot.val() || {};
  document.querySelectorAll('.token').forEach(el => el.remove());
  for (let key in tokens) {
    const data = tokens[key];
    const img = document.createElement('img');
    img.src = data.src;
    img.classList.add('token');
    img.draggable = true;
    img.style.top = `${data.top}px`;
    img.style.left = `${data.left}px`;
    img.style.width = `${data.width}px`;
    img.style.height = `${data.height}px`;
    img.dataset.id = data.id;

    let offsetX = 0, offsetY = 0;

    img.addEventListener('dragstart', (e) => {
      offsetX = e.offsetX;
      offsetY = e.offsetY;
      e.dataTransfer.setData('tokenId', data.id);
    });

    img.addEventListener('dragend', (e) => {
      const rect = grid.getBoundingClientRect();
      const newLeft = e.clientX - rect.left - offsetX;
      const newTop = e.clientY - rect.top - offsetY;
      db.ref('tokens/' + data.id).update({ left: newLeft, top: newTop });
    });

    grid.appendChild(img);
  }
});


// LIBRARY: kategorie a nahrávání
const categoriesList = document.getElementById('categoriesList');
const createCategoryBtn = document.getElementById('createCategoryBtn');
const newCategoryName = document.getElementById('newCategoryName');
const libraryUpload = document.getElementById('libraryUpload');
let selectedCategory = null;

function renderCategories(lib) {
  categoriesList.innerHTML = '';
  for (const catName of Object.keys(lib || {})) {
    const cat = document.createElement('div');
    cat.className = 'category';

    const header = document.createElement('div');
    header.className = 'category-header';

    const title = document.createElement('div');
    title.textContent = catName;

    const actions = document.createElement('div');

    const selectBtn = document.createElement('button');
    selectBtn.textContent = selectedCategory === catName ? 'Vybráno' : 'Vybrat';
    selectBtn.addEventListener('click', () => {
      selectedCategory = catName;
      renderLibrary(lib);
    });

    const delBtn = document.createElement('button');
    delBtn.textContent = 'Smazat';
    delBtn.addEventListener('click', () => {
      if (confirm(`Smazat kategorii ${catName} a všechny její obrázky?`)) {
        db.ref('library/' + catName).remove();
      }
    });

    actions.appendChild(selectBtn);
    actions.appendChild(delBtn);

    header.appendChild(title);
    header.appendChild(actions);

    cat.appendChild(header);

    const imagesWrap = document.createElement('div');
    imagesWrap.className = 'category-images';

    const images = lib[catName] || {};
    for (const imgId of Object.keys(images)) {
      const imgData = images[imgId];
      const imgEl = document.createElement('img');
      imgEl.src = imgData.src;
      imgEl.className = 'library-token';
      imgEl.draggable = true;
      imgEl.dataset.src = imgData.src;
      imgEl.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('src', imgData.src);
      });

      // small delete per image
      const wrapper = document.createElement('div');
      wrapper.style.position = 'relative';
      wrapper.appendChild(imgEl);

      const delImgBtn = document.createElement('button');
      delImgBtn.textContent = 'x';
      delImgBtn.title = 'Smazat obrázek z knihovny';
      delImgBtn.style.position = 'absolute';
      delImgBtn.style.top = '0';
      delImgBtn.style.right = '0';
      delImgBtn.style.background = '#900';
      delImgBtn.style.color = '#fff';
      delImgBtn.style.border = 'none';
      delImgBtn.style.padding = '2px 4px';
      delImgBtn.style.cursor = 'pointer';
      delImgBtn.addEventListener('click', () => {
        if (confirm('Smazat tento obrázek?')) {
          db.ref('library/' + catName + '/' + imgId).remove();
        }
      });

      wrapper.appendChild(delImgBtn);
      imagesWrap.appendChild(wrapper);
    }

    cat.appendChild(imagesWrap);
    categoriesList.appendChild(cat);
  }
}

function renderLibrary(lib) {
  // ensure selectedCategory exists
  if (!selectedCategory) {
    // pick first
    const keys = Object.keys(lib || {});
    selectedCategory = keys.length ? keys[0] : null;
  }
  renderCategories(lib);
}

// Listen to library changes
db.ref('library').on('value', (snap) => {
  const lib = snap.val() || {};
  renderLibrary(lib);
});

createCategoryBtn.addEventListener('click', () => {
  const name = (newCategoryName.value || '').trim();
  if (!name) return alert('Zadejte název kategorie');
  db.ref('library/' + name).set({});
  newCategoryName.value = '';
});
libraryUpload.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return alert('Vyberte kategorii nebo vytvořte novou');
  if (!selectedCategory) return alert('Vyberte nejprve kategorii (klikněte Vybrat u kategorie)');

  const reader = new FileReader();
  reader.onload = function (event) {
    const id = Date.now();
    db.ref('library/' + selectedCategory + '/' + id).set({ id, src: event.target.result });
  };
  reader.readAsDataURL(file);
  e.target.value = '';
});
// grid drag/drop


document.querySelectorAll('.library-token').forEach(token => {
  token.addEventListener('dragstart', (e) => {
    e.dataTransfer.setData('src', token.src);
  });
});

grid.addEventListener('dragover', (e) => e.preventDefault());
grid.addEventListener('drop', (e) => {
  e.preventDefault();
  const rect = grid.getBoundingClientRect();
  const tokenId = e.dataTransfer.getData('tokenId');
  const src = e.dataTransfer.getData('src');

  if (tokenId) {
    const newLeft = e.clientX - rect.left;
    const newTop = e.clientY - rect.top;
    db.ref('tokens/' + tokenId).update({ left: newLeft, top: newTop });
  } else if (src) {
    const id = Date.now();
    db.ref('tokens/' + id).set({
      id,
      src,
      top: e.clientY - rect.top,
      left: e.clientX - rect.left,
      width: cellSize,
      height: cellSize
    });
  }
});


const backgroundInput = document.getElementById('backgroundUpload');
const background = document.getElementById('background');

function startRealtimeSync() {
  db.ref('background').on('value', (snapshot) => {
    if (snapshot.val()) {
      background.src = snapshot.val();
    }
  });

  backgroundInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (event) {
      const imageUrl = event.target.result;
      background.src = imageUrl;
      db.ref('background').set(imageUrl);
    };

    reader.readAsDataURL(file);
    e.target.value = "";
  });
}

firebase.auth().signInAnonymously()
  .then(() => {
    console.log("✅ Přihlášen anonymně");
    startRealtimeSync();
  })
  .catch((error) => {
    console.error("❌ Přihlášení selhalo:", error);
  });
const deleteAllTokensBtn = document.getElementById('deleteAllTokensBtn');

deleteAllTokensBtn.addEventListener('click', () => {
  if (confirm('Opravdu chcete smazat všechny tokeny z mřížky?')) {
    db.ref('tokens').remove()
      .then(() => {
        console.log('Všechny tokeny smazány');
        document.querySelectorAll('#grid .token').forEach(t => t.remove());
      })
      .catch(console.error);
  }
});


const drawCanvas = document.getElementById('drawLayer');

function resizeCanvas() {
  drawCanvas.width = gridContainer.clientWidth;
  drawCanvas.height = gridContainer.clientHeight;
}

resizeCanvas();

window.addEventListener('resize', () => {
  resizeCanvas();
  createGrid();
});



const ctx = drawCanvas.getContext('2d');
let drawing = false;
let drawMode = false;

const drawColorInput = document.getElementById('drawColor');
const toggleDrawBtn = document.getElementById('toggleDraw');
const clearCanvasBtn = document.getElementById('clearCanvas');

toggleDrawBtn.addEventListener('click', () => {
  drawMode = !drawMode;
  drawCanvas.style.pointerEvents = drawMode ? 'auto' : 'none';
  toggleDrawBtn.textContent = drawMode ? 'Vypnout kreslení' : 'Režim kreslení';
});


clearCanvasBtn.addEventListener('click', () => {
  ctx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
});

drawCanvas.addEventListener('mousedown', (e) => {
  if (!drawMode) return;
  drawing = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
});

drawCanvas.addEventListener('mousemove', (e) => {
  if (!drawMode || !drawing) return;
  ctx.strokeStyle = drawColorInput.value;
  ctx.lineWidth = 2;
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
});

drawCanvas.addEventListener('mouseup', () => {
  drawing = false;
  ctx.closePath();
});

drawCanvas.addEventListener('mouseleave', () => {
  drawing = false;
  ctx.closePath();
});


  </script>
</body>
</html>